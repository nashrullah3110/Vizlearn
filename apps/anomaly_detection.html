<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Explainer: Anomaly Detection</title>
    
    <!-- External Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Custom theme configuration */
        body {
            font-family: 'Roboto Mono', monospace;
        }
        
        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #374151;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #8b5cf6;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a78bfa;
        }
        
        /* Button styles */
        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #a78bfa, #c4b5fd);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #374151;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
            transform: translateY(-1px);
        }
        
        /* Custom slider styles */
        .threshold-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #374151;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .threshold-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #8b5cf6;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }
        
        .threshold-slider::-webkit-slider-thumb:hover {
            background: #a78bfa;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.5);
        }
        
        .threshold-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #8b5cf6;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }
        
        /* Canvas container */
        .canvas-container {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 400px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        #anomalyCanvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
            border-radius: 8px;
        }
        
        /* Anomaly log styles */
        .anomaly-log {
            max-height: 120px;
            overflow-y: auto;
            background: #101827;
            border: 1px solid #374151;
            border-radius: 6px;
            padding: 8px;
        }
        
        .anomaly-item {
            background: #8b5cf6;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            margin: 2px 0;
            display: inline-block;
        }
        
        /* Animation classes */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse-anomaly {
            animation: pulseAnomaly 1s ease-in-out;
        }
        
        @keyframes pulseAnomaly {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }
        
        /* Status indicators */
        .status-normal {
            color: #10b981;
        }
        
        .status-anomaly {
            color: #ef4444;
        }
        
        .threshold-value {
            background: #8b5cf6;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-[#101827] text-[#f3f4f6] flex flex-col min-h-screen">
    <!-- Header -->
    <header class="py-6 px-4 text-center border-b border-[#374151]">
        <h1 class="text-3xl md:text-4xl font-bold text-[#f3f4f6]">
            Interactive Explainer: Anomaly Detection
        </h1>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col lg:flex-row gap-6 p-6">
        <!-- Left Panel: Controls & Explanation (35% width) -->
        <div class="lg:w-1/3 bg-[#1f2937] rounded-xl p-6 border border-[#374151]">
            <div class="h-full flex flex-col space-y-6">
                <!-- Explanation -->
                <div>
                    <h2 class="text-lg font-semibold mb-4 text-[#f3f4f6]">
                        <i class="fas fa-search text-[#8b5cf6] mr-2"></i>
                        What is Anomaly Detection?
                    </h2>
                    <div class="text-[#9ca3af] text-sm leading-relaxed space-y-3">
                        <p>
                            Anomaly detection identifies data points that significantly deviate from the expected pattern or "normal" behavior in a dataset.
                        </p>
                        <p>
                            <strong class="text-[#f3f4f6]">Key Concept:</strong> We define a threshold that determines what we consider "normal." Points outside this boundary are flagged as anomalies.
                        </p>
                        <div class="bg-[#101827] border border-[#374151] rounded-lg p-3 text-xs">
                            <div class="flex items-center mb-2">
                                <div class="w-3 h-3 bg-[#9ca3af] rounded-full mr-2"></div>
                                <span>Normal Points</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-[#ef4444] rounded-full mr-2"></div>
                                <span>Anomalies</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="flex-grow">
                    <h3 class="text-lg font-semibold mb-4 text-[#f3f4f6]">
                        <i class="fas fa-sliders-h text-[#8b5cf6] mr-2"></i>
                        Detection Controls
                    </h3>
                    
                    <!-- Detection Threshold Slider -->
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between items-center mb-3">
                                <label class="text-sm font-medium text-[#f3f4f6]">
                                    Detection Threshold
                                </label>
                                <span id="thresholdValue" class="threshold-value">2.0</span>
                            </div>
                            <input 
                                type="range" 
                                id="thresholdSlider" 
                                class="threshold-slider"
                                min="0.5" 
                                max="4.0" 
                                step="0.1" 
                                value="2.0"
                            >
                            <div class="flex justify-between text-xs text-[#9ca3af] mt-1">
                                <span>Sensitive</span>
                                <span>Conservative</span>
                            </div>
                            <p class="text-xs text-[#9ca3af] mt-2">
                                Lower values detect more anomalies. Higher values are more conservative.
                            </p>
                        </div>
                        
                        <!-- Control Buttons -->
                        <div class="space-y-3">
                            <button 
                                id="generateDataBtn" 
                                class="btn-primary w-full py-3 px-4 rounded-lg font-medium text-white flex items-center justify-center"
                            >
                                <i class="fas fa-refresh mr-2"></i>
                                Generate New Data
                            </button>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <button 
                                    id="resetViewBtn" 
                                    class="btn-secondary py-2 px-3 rounded-lg font-medium text-[#f3f4f6] flex items-center justify-center text-sm"
                                >
                                    <i class="fas fa-expand mr-2"></i>
                                    Reset View
                                </button>
                                
                                <button 
                                    id="clearAnomaliesBtn" 
                                    class="btn-secondary py-2 px-3 rounded-lg font-medium text-[#f3f4f6] flex items-center justify-center text-sm"
                                >
                                    <i class="fas fa-eraser mr-2"></i>
                                    Clear All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Anomaly Statistics -->
                <div class="bg-[#101827] border border-[#374151] rounded-lg p-4">
                    <h4 class="text-sm font-semibold text-[#a78bfa] mb-3">
                        <i class="fas fa-chart-bar mr-1"></i>
                        Detection Statistics
                    </h4>
                    <div class="space-y-2 text-xs">
                        <div class="flex justify-between">
                            <span class="text-[#9ca3af]">Total Points:</span>
                            <span id="totalPoints" class="text-[#f3f4f6] font-mono">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-[#9ca3af]">Normal Points:</span>
                            <span id="normalPoints" class="status-normal font-mono">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-[#9ca3af]">Anomalies:</span>
                            <span id="anomalyPoints" class="status-anomaly font-mono">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-[#9ca3af]">Anomaly Rate:</span>
                            <span id="anomalyRate" class="text-[#8b5cf6] font-mono">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Anomaly Log -->
                <div>
                    <h4 class="text-sm font-semibold text-[#a78bfa] mb-3">
                        <i class="fas fa-list mr-1"></i>
                        Recent Anomalies
                    </h4>
                    <div id="anomalyLog" class="anomaly-log">
                        <div class="text-xs text-[#9ca3af] text-center">
                            No anomalies detected yet
                        </div>
                    </div>
                </div>

                <!-- Instructions -->
                <div class="bg-[#101827] border border-[#374151] rounded-lg p-4">
                    <h4 class="text-sm font-semibold text-[#a78bfa] mb-2">
                        <i class="fas fa-mouse-pointer mr-1"></i>
                        How to Interact
                    </h4>
                    <div class="text-xs text-[#9ca3af] space-y-1">
                        <div>• Adjust the threshold slider to change sensitivity</div>
                        <div>• Click on the plot to add new data points</div>
                        <div>• Generate new datasets to see different patterns</div>
                        <div>• Watch how anomalies change in real-time</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Visualization (65% width) -->
        <div class="lg:w-2/3 bg-[#1f2937] rounded-xl p-6 border border-[#374151]">
            <div class="h-full flex flex-col">
                <!-- Visualization Header -->
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-[#f3f4f6]">
                        <i class="fas fa-chart-scatter text-[#8b5cf6] mr-2"></i>
                        Anomaly Detection Visualization
                    </h2>
                    <div class="flex items-center space-x-4 text-sm">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-[#8b5cf6] rounded-full mr-2 opacity-30"></div>
                            <span class="text-[#9ca3af]">Detection Boundary</span>
                        </div>
                        <div id="detectionStatus" class="text-xs px-3 py-1 rounded-full bg-[#101827] border border-[#374151]">
                            <span class="text-[#9ca3af]">Ready</span>
                        </div>
                    </div>
                </div>
                
                <!-- Canvas Container -->
                <div class="flex-grow canvas-container bg-[#101827] border border-[#374151]">
                    <canvas id="anomalyCanvas"></canvas>
                </div>
                
                <!-- Canvas Instructions -->
                <div class="mt-4 text-center">
                    <p class="text-xs text-[#9ca3af]">
                        <i class="fas fa-hand-pointer text-[#8b5cf6] mr-1"></i>
                        Click anywhere on the plot to add a new data point and see if it's detected as an anomaly
                    </p>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-[#1f2937] border-t border-[#374151] py-6 mt-auto">
        <div class="flex justify-center space-x-6">
            <a href="https://www.linkedin.com/in/ashish-jangra/" target="_blank" rel="noopener noreferrer" 
               class="text-[#9ca3af] hover:text-[#a78bfa] transition-colors duration-300">
                <i class="fab fa-linkedin fa-2x"></i>
            </a>
            <a href="https://github.com/AshishJangra27" target="_blank" rel="noopener noreferrer" 
               class="text-[#9ca3af] hover:text-[#a78bfa] transition-colors duration-300">
                <i class="fab fa-github fa-2x"></i>
            </a>
            <a href="https://www.kaggle.com/ashishjangra27" target="_blank" rel="noopener noreferrer" 
               class="text-[#9ca3af] hover:text-[#a78bfa] transition-colors duration-300">
                <i class="fab fa-kaggle fa-2x"></i>
            </a>
            <a href="https://huggingface.co/ashish-jangra" target="_blank" rel="noopener noreferrer" 
               class="text-[#9ca3af] hover:text-[#a78bfa] transition-colors duration-300">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12.036 3L4.5 7.73v8.54l7.536 4.73 7.536-4.73V7.73L12.036 3zm5.157 3.74L12 10.5 6.807 6.74 12 4.73l5.193 2.01zm-5.157 12.72l-5.036-3.16V9.04L12 13.08l5.036-4.04v7.26L12.036 19.46z"/>
                </svg>
            </a>
            <a href="https://www.instagram.com/ashish_zangra/" target="_blank" rel="noopener noreferrer" 
               class="text-[#9ca3af] hover:text-[#a78bfa] transition-colors duration-300">
                <i class="fab fa-instagram fa-2x"></i>
            </a>
        </div>
    </footer>

    <script>
        // Global variables
        let canvas, ctx;
        let dataPoints = [];
        let threshold = 2.0;
        let centerX, centerY;
        let scale = 1;
        let animationId = null;
        
        // Data point structure: {x, y, isAnomaly, isUserAdded, timestamp}
        
        // DOM elements
        const thresholdSlider = document.getElementById('thresholdSlider');
        const thresholdValue = document.getElementById('thresholdValue');
        const generateDataBtn = document.getElementById('generateDataBtn');
        const resetViewBtn = document.getElementById('resetViewBtn');
        const clearAnomaliesBtn = document.getElementById('clearAnomaliesBtn');
        const anomalyLog = document.getElementById('anomalyLog');
        const totalPoints = document.getElementById('totalPoints');
        const normalPoints = document.getElementById('normalPoints');
        const anomalyPoints = document.getElementById('anomalyPoints');
        const anomalyRate = document.getElementById('anomalyRate');
        const detectionStatus = document.getElementById('detectionStatus');
        
        // Initialize the application
        function init() {
            canvas = document.getElementById('anomalyCanvas');
            ctx = canvas.getContext('2d');
            
            setupCanvas();
            setupEventListeners();
            generateNormalData();
            updateDetection();
            startRenderLoop();
        }
        
        // Setup canvas dimensions and properties
        function setupCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            
            centerX = canvas.width / 2;
            centerY = canvas.height / 2;
            scale = Math.min(canvas.width, canvas.height) / 8;
            
            // Handle high DPI displays
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            
            ctx.scale(dpr, dpr);
            
            centerX = rect.width / 2;
            centerY = rect.height / 2;
            scale = Math.min(rect.width, rect.height) / 8;
        }
        
        // Setup event listeners
        function setupEventListeners() {
            thresholdSlider.addEventListener('input', (e) => {
                threshold = parseFloat(e.target.value);
                thresholdValue.textContent = threshold.toFixed(1);
                updateDetection();
            });
            
            generateDataBtn.addEventListener('click', () => {
                generateNormalData();
                updateDetection();
                detectionStatus.innerHTML = '<span class="text-[#10b981]">New Data Generated</span>';
                setTimeout(() => {
                    detectionStatus.innerHTML = '<span class="text-[#9ca3af]">Ready</span>';
                }, 2000);
            });
            
            resetViewBtn.addEventListener('click', () => {
                setupCanvas();
                detectionStatus.innerHTML = '<span class="text-[#8b5cf6]">View Reset</span>';
                setTimeout(() => {
                    detectionStatus.innerHTML = '<span class="text-[#9ca3af]">Ready</span>';
                }, 1500);
            });
            
            clearAnomaliesBtn.addEventListener('click', () => {
                dataPoints = dataPoints.filter(point => !point.isUserAdded);
                updateDetection();
                detectionStatus.innerHTML = '<span class="text-[#ef4444]">Manual Points Cleared</span>';
                setTimeout(() => {
                    detectionStatus.innerHTML = '<span class="text-[#9ca3af]">Ready</span>';
                }, 2000);
            });
            
            canvas.addEventListener('click', handleCanvasClick);
            window.addEventListener('resize', setupCanvas);
        }
        
        // Generate normal data points with some natural spread
        function generateNormalData() {
            dataPoints = [];
            const numPoints = 50 + Math.floor(Math.random() * 30); // 50-80 points
            
            for (let i = 0; i < numPoints; i++) {
                // Generate points in a roughly circular distribution
                const angle = Math.random() * 2 * Math.PI;
                const radius = Math.sqrt(Math.random()) * 1.5; // Bias toward center
                
                const x = Math.cos(angle) * radius;
                const y = Math.sin(angle) * radius;
                
                dataPoints.push({
                    x: x,
                    y: y,
                    isAnomaly: false,
                    isUserAdded: false,
                    timestamp: Date.now()
                });
            }
            
            // Add a few natural outliers
            const numOutliers = 2 + Math.floor(Math.random() * 3);
            for (let i = 0; i < numOutliers; i++) {
                const angle = Math.random() * 2 * Math.PI;
                const radius = 2.5 + Math.random() * 1.5;
                
                const x = Math.cos(angle) * radius;
                const y = Math.sin(angle) * radius;
                
                dataPoints.push({
                    x: x,
                    y: y,
                    isAnomaly: false,
                    isUserAdded: false,
                    timestamp: Date.now()
                });
            }
        }
        
        // Handle canvas click to add new data points
        function handleCanvasClick(event) {
            const rect = canvas.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const clickY = event.clientY - rect.top;
            
            // Convert screen coordinates to data coordinates
            const dataX = (clickX - centerX) / scale;
            const dataY = (clickY - centerY) / scale;
            
            // Add new data point
            const newPoint = {
                x: dataX,
                y: dataY,
                isAnomaly: false,
                isUserAdded: true,
                timestamp: Date.now()
            };
            
            dataPoints.push(newPoint);
            updateDetection();
            
            // Visual feedback
            detectionStatus.innerHTML = '<span class="text-[#8b5cf6]">Point Added</span>';
            setTimeout(() => {
                detectionStatus.innerHTML = '<span class="text-[#9ca3af]">Ready</span>';
            }, 1500);
        }
        
        // Update anomaly detection based on current threshold
        function updateDetection() {
            let normalCount = 0;
            let anomalyCount = 0;
            const recentAnomalies = [];
            
            dataPoints.forEach(point => {
                // Calculate distance from center (0,0)
                const distance = Math.sqrt(point.x * point.x + point.y * point.y);
                
                // Check if point is an anomaly based on threshold
                const wasAnomaly = point.isAnomaly;
                point.isAnomaly = distance > threshold;
                
                if (point.isAnomaly) {
                    anomalyCount++;
                    // If this is a newly detected anomaly, add to log
                    if (!wasAnomaly || point.isUserAdded) {
                        recentAnomalies.push({
                            x: point.x.toFixed(2),
                            y: point.y.toFixed(2),
                            distance: distance.toFixed(2),
                            timestamp: point.timestamp
                        });
                    }
                } else {
                    normalCount++;
                }
            });
            
            // Update statistics
            updateStatistics(normalCount, anomalyCount);
            
            // Update anomaly log
            updateAnomalyLog(recentAnomalies);
        }
        
        // Update statistics display
        function updateStatistics(normalCount, anomalyCount) {
            const total = normalCount + anomalyCount;
            const rate = total > 0 ? (anomalyCount / total * 100).toFixed(1) : 0;
            
            totalPoints.textContent = total;
            normalPoints.textContent = normalCount;
            anomalyPoints.textContent = anomalyCount;
            anomalyRate.textContent = rate + '%';
        }
        
        // Update anomaly log
        function updateAnomalyLog(newAnomalies) {
            if (newAnomalies.length === 0) return;
            
            // Clear "no anomalies" message if present
            if (anomalyLog.children.length === 1 && 
                anomalyLog.children[0].textContent.includes('No anomalies')) {
                anomalyLog.innerHTML = '';
            }
            
            // Add new anomalies to log
            newAnomalies.forEach(anomaly => {
                const anomalyItem = document.createElement('div');
                anomalyItem.className = 'anomaly-item fade-in';
                anomalyItem.textContent = `(${anomaly.x}, ${anomaly.y}) d=${anomaly.distance}`;
                
                anomalyLog.insertBefore(anomalyItem, anomalyLog.firstChild);
                
                // Remove old entries (keep last 10)
                while (anomalyLog.children.length > 10) {
                    anomalyLog.removeChild(anomalyLog.lastChild);
                }
            });
            
            // Scroll to top
            anomalyLog.scrollTop = 0;
        }
        
        // Main render loop
        function startRenderLoop() {
            function render() {
                drawVisualization();
                animationId = requestAnimationFrame(render);
            }
            render();
        }
        
        // Draw the main visualization
        function drawVisualization() {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid
            drawGrid();
            
            // Draw detection boundary
            drawDetectionBoundary();
            
            // Draw data points
            drawDataPoints();
            
            // Draw center point
            drawCenterPoint();
        }
        
        // Draw background grid
        function drawGrid() {
            ctx.strokeStyle = '#374151';
            ctx.lineWidth = 0.5;
            ctx.setLineDash([2, 4]);
            
            const gridSpacing = scale;
            const startX = centerX % gridSpacing;
            const startY = centerY % gridSpacing;
            
            // Vertical lines
            for (let x = startX; x < canvas.width; x += gridSpacing) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            // Horizontal lines
            for (let y = startY; y < canvas.height; y += gridSpacing) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            ctx.setLineDash([]);
        }
        
        // Draw detection boundary circle
        function drawDetectionBoundary() {
            ctx.strokeStyle = '#8b5cf6';
            ctx.lineWidth = 2;
            ctx.setLineDash([8, 4]);
            ctx.globalAlpha = 0.6;
            
            ctx.beginPath();
            ctx.arc(centerX, centerY, threshold * scale, 0, 2 * Math.PI);
            ctx.stroke();
            
            // Fill area inside boundary with subtle color
            ctx.fillStyle = '#8b5cf6';
            ctx.globalAlpha = 0.05;
            ctx.fill();
            
            ctx.setLineDash([]);
            ctx.globalAlpha = 1;
        }
        
        // Draw all data points
        function drawDataPoints() {
            const currentTime = Date.now();
            
            dataPoints.forEach(point => {
                const screenX = centerX + point.x * scale;
                const screenY = centerY + point.y * scale;
                
                // Skip points outside visible area
                if (screenX < -20 || screenX > canvas.width + 20 || 
                    screenY < -20 || screenY > canvas.height + 20) {
                    return;
                }
                
                // Determine point appearance
                let color, size;
                if (point.isAnomaly) {
                    color = '#ef4444'; // Red for anomalies
                    size = point.isUserAdded ? 8 : 6;
                } else {
                    color = '#9ca3af'; // Gray for normal points
                    size = point.isUserAdded ? 6 : 4;
                }
                
                // Add glow effect for user-added points
                if (point.isUserAdded) {
                    const age = currentTime - point.timestamp;
                    if (age < 2000) { // Glow for 2 seconds
                        const glowIntensity = Math.max(0, 1 - age / 2000);
                        ctx.shadowColor = color;
                        ctx.shadowBlur = 10 * glowIntensity;
                    }
                }
                
                // Draw point
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(screenX, screenY, size, 0, 2 * Math.PI);
                ctx.fill();
                
                // Add border for better visibility
                ctx.strokeStyle = '#1f2937';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // Reset shadow
                ctx.shadowBlur = 0;
                
                // Add pulse effect for recently detected anomalies
                if (point.isAnomaly && point.isUserAdded) {
                    const age = currentTime - point.timestamp;
                    if (age < 1000) {
                        const pulseIntensity = Math.sin(age * 0.01) * 0.5 + 0.5;
                        ctx.strokeStyle = '#ef4444';
                        ctx.lineWidth = 2;
                        ctx.globalAlpha = pulseIntensity * 0.5;
                        ctx.beginPath();
                        ctx.arc(screenX, screenY, size + 4, 0, 2 * Math.PI);
                        ctx.stroke();
                        ctx.globalAlpha = 1;
                    }
                }
            });
        }
        
        // Draw center reference point
        function drawCenterPoint() {
            ctx.fillStyle = '#8b5cf6';
            ctx.strokeStyle = '#a78bfa';
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            ctx.arc(centerX, centerY, 3, 0, 2 * Math.PI);
            ctx.fill();
            ctx.stroke();
            
            // Draw crosshair
            ctx.strokeStyle = '#8b5cf6';
            ctx.lineWidth = 1;
            ctx.setLineDash([3, 3]);
            
            ctx.beginPath();
            ctx.moveTo(centerX - 10, centerY);
            ctx.lineTo(centerX + 10, centerY);
            ctx.moveTo(centerX, centerY - 10);
            ctx.lineTo(centerX, centerY + 10);
            ctx.stroke();
            
            ctx.setLineDash([]);
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
            } else {
                startRenderLoop();
            }
        });
    </script>
</body>
</html>
